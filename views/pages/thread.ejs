<%- include('../partials/header') %>
<section class="container section">
  <div class="thread-header">
    <div class="thread-identity">
      <% const recipientName = thread.buyer_id === currentUser.id ? thread.seller_name : thread.buyer_name; %>
      <% const recipientInitial = (recipientName || '?').charAt(0).toUpperCase(); %>
      <div class="thread-avatar"><%= recipientInitial %></div>
      <div class="thread-meta">
        <p class="thread-label">Chatting with</p>
        <h1><%= recipientName %></h1>
        <% if (thread.listing_id) { %>
          <a class="thread-listing-link" href="/listings/<%= thread.listing_id %>"><%= thread.listing_title || 'View listing' %></a>
        <% } else { %>
          <span class="meta">General inquiry</span>
        <% } %>
      </div>
    </div>
    <a class="link" href="/messages">Back to inbox</a>
  </div>
  <div class="thread-body">
    <div class="thread-messages" id="threadMessages">
    <% messages.forEach(message => { %>
      <div class="message <%= message.sender_id === currentUser.id ? 'sent' : 'received' %>">
        <p><%= message.body %></p>
        <span class="message-time"><%= new Date(message.created_at).toLocaleString() %></span>
      </div>
    <% }) %>
    </div>
    <form class="message-input" method="POST" action="/messages/<%= thread.id %>">
      <textarea class="message-textarea" name="body" rows="3" placeholder="Type your message" required></textarea>
      <button class="button primary send-button" type="submit" aria-label="Send message">
        <span class="send-label">Send</span>
        <svg class="send-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 11.5l17-8-6.5 17-2-6.5L3 11.5z" fill="currentColor" />
        </svg>
      </button>
    </form>
  </div>
</section>

<script>
  const threadMessages = document.getElementById('threadMessages');
  if (threadMessages) {
    threadMessages.scrollTop = threadMessages.scrollHeight;
  }
</script>
<%- include('../partials/footer') %>
