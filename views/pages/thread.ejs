<%- include('../partials/header') %>
<section class="container section">
  <div class="thread-header">
    <div class="thread-identity">
      <% const recipientName = thread.buyer_id === currentUser.id ? thread.seller_name : thread.buyer_name; %>
      <% const recipientInitial = (recipientName || '?').charAt(0).toUpperCase(); %>
      <div class="thread-avatar"><%= recipientInitial %></div>
      <div class="thread-meta">
        <p class="thread-label">Chatting with</p>
        <h1><%= recipientName %></h1>
        <% if (thread.listing_id) { %>
          <a class="thread-listing-link" href="/listings/<%= thread.listing_id %>"><%= thread.listing_title || 'View listing' %></a>
        <% } else { %>
          <span class="meta">General inquiry</span>
        <% } %>
      </div>
    </div>
    <a class="link" href="/messages">Back to inbox</a>
  </div>
  <div class="thread-body">
    <div class="thread-messages" id="threadMessages">
    <% messages.forEach(message => { %>
      <% const isCurrentUser = message.sender_id === currentUser.id; %>
      <% const senderName = isCurrentUser ? 'You' : message.sender_name; %>
      <% const senderInitial = (senderName || '?').charAt(0).toUpperCase(); %>
      <div class="message-row <%= isCurrentUser ? 'me' : 'them' %>">
        <div class="message-avatar">
          <% if (message.sender_avatar) { %>
            <img src="<%= message.sender_avatar %>" alt="<%= senderName %> avatar" />
          <% } else { %>
            <span><%= senderInitial %></span>
          <% } %>
        </div>
        <div class="message-content">
          <div class="message-meta">
            <span class="message-sender"><%= senderName %></span>
            <span class="message-timestamp"><%= new Date(message.created_at).toLocaleString() %></span>
          </div>
          <div class="message-bubble"><%= message.body %></div>
        </div>
      </div>
    <% }) %>
    </div>
    <form class="message-composer" method="POST" action="/messages/<%= thread.id %>">
      <div class="composer-input">
        <textarea class="message-textarea" name="body" rows="2" placeholder="Message <%= recipientName %>" required></textarea>
      </div>
      <button class="button primary send-button" type="submit" aria-label="Send message">
        <span class="send-label">Send</span>
        <svg class="send-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 11.5l17-8-6.5 17-2-6.5L3 11.5z" fill="currentColor" />
        </svg>
      </button>
    </form>
  </div>
</section>

<script>
  const threadMessages = document.getElementById('threadMessages');
  if (threadMessages) {
    threadMessages.scrollTop = threadMessages.scrollHeight;
  }
</script>
<%- include('../partials/footer') %>
