<%- include('../partials/header') %>
<section class="container section">
  <div class="thread-header">
    <div>
      <% const recipientName = thread.buyer_id === currentUser.id ? thread.seller_name : thread.buyer_name; %>
      <h1>Chat with <%= recipientName %></h1>
      <p class="meta"><%= thread.listing_title || 'General inquiry' %></p>
    </div>
    <a class="link" href="/messages">Back to inbox</a>
  </div>
  <div class="thread-body">
    <div class="thread-messages" id="threadMessages">
    <% messages.forEach(message => { %>
      <div class="message <%= message.sender_id === currentUser.id ? 'sent' : 'received' %>">
        <p><%= message.body %></p>
        <span class="message-time"><%= new Date(message.created_at).toLocaleString() %></span>
      </div>
    <% }) %>
    </div>
    <form class="message-input" method="POST" action="/messages/<%= thread.id %>">
      <textarea class="message-textarea" name="body" rows="3" placeholder="Type your message" required></textarea>
      <button class="button primary send-button" type="submit" aria-label="Send message">
        <span class="send-label">Send</span>
        <svg class="send-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 11.5l17-8-6.5 17-2-6.5L3 11.5z" fill="currentColor" />
        </svg>
      </button>
    </form>
  </div>
  <form class="message-input" method="POST" action="/messages/<%= thread.id %>">
    <textarea name="body" rows="3" placeholder="Type your message" required></textarea>
    <button class="button primary send-button" type="submit" aria-label="Send message">Send</button>
  </form>
</section>

<script>
  const threadMessages = document.getElementById('threadMessages');
  if (threadMessages) {
    threadMessages.scrollTop = threadMessages.scrollHeight;
  }
</script>
<%- include('../partials/footer') %>
