<%- include('../partials/header') %>
<section class="container section">
  <div class="detail-grid">
    <div>
      <img class="detail-image" src="<%= order.image_url %>" alt="<%= order.title %>" />
      <div class="detail-tags">
        <span class="badge ghost">Order #<%= order.id %></span>
        <span class="status-badge <%= order.status.toLowerCase() %>"><%= order.status %></span>
      </div>
    </div>
    <div>
      <h1><%= order.title %></h1>
      <p class="price"><%= formatPrice(order.price_cents) %></p>
      <p class="meta">Buyer: <%= order.buyer_name %> Â· Seller: <%= order.seller_name %></p>

      <div class="timeline">
        <div class="timeline-step <%= order.paid_at ? 'complete' : '' %>">
          <span>Paid</span>
          <p><%= order.paid_at ? new Date(order.paid_at).toLocaleString() : 'Pending' %></p>
        </div>
        <div class="timeline-step <%= order.shipped_at ? 'complete' : '' %>">
          <span>Shipped</span>
          <p><%= order.shipped_at ? new Date(order.shipped_at).toLocaleString() : 'Pending' %></p>
        </div>
        <div class="timeline-step <%= order.confirmed_at ? 'complete' : '' %>">
          <span>Completed</span>
          <p><%= order.confirmed_at ? new Date(order.confirmed_at).toLocaleString() : 'Pending' %></p>
        </div>
      </div>

      <div class="info-box">
        <h4>Shipping details</h4>
        <p><%= order.shipping_details %></p>
        <% if (order.tracking_code) { %>
          <p>Tracking: <%= order.tracking_code %></p>
        <% } %>
      </div>

      <% if (currentUser.id === order.seller_id) { %>
        <div class="action-column">
          <form method="POST" action="/orders/<%= order.id %>/ship" class="form-card">
            <label>
              Tracking number (or leave blank)
              <input type="text" name="trackingCode" placeholder="Tracking number" />
            </label>
            <button class="button primary" type="submit" <%= order.status === 'completed' ? 'disabled' : '' %>>
              Mark as shipped
            </button>
          </form>
        </div>
      <% } %>
      <% if (currentUser.id === order.buyer_id) { %>
        <div class="action-column">
          <div class="notice">Confirm once the item arrives to release funds.</div>
          <form method="POST" action="/orders/<%= order.id %>/complete">
            <button class="button primary" type="submit" <%= order.status !== 'shipped' ? 'disabled' : '' %>>
              Confirm received
            </button>
          </form>
        </div>
      <% } %>
      <a class="link" href="/messages">Go to messages</a>
    </div>
  </div>
</section>

<script>
  const statusBadge = document.querySelector('.status-badge');
  if (statusBadge) {
    statusBadge.textContent = statusBadge.textContent.replace(/_/g, ' ');
  }
</script>
<%- include('../partials/footer') %>
