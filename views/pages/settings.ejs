<%- include('../partials/header') %>
<section class="container section">
  <div class="section-header">
    <div>
      <h1>Settings</h1>
      <p class="muted">Update your account details, login info, and notification preferences.</p>
    </div>
  </div>

  <% if (error) { %>
    <div class="error"><%= error %></div>
  <% } %>
  <% if (success) { %>
    <div class="success"><%= success %></div>
  <% } %>

  <div class="settings-grid">
    <form class="form-card settings-card" method="POST" action="/settings/profile" enctype="multipart/form-data">
      <h3>Account profile</h3>
      <div class="profile-editor">
        <div class="profile-avatar small">
          <% if (user.avatar_url) { %>
            <img src="<%= user.avatar_url %>" alt="<%= user.username %> avatar" />
          <% } else { %>
            <span><%= user.username.slice(0, 1).toUpperCase() %></span>
          <% } %>
        </div>
        <div class="profile-editor-fields">
          <label>
            Username
            <input type="text" name="username" value="<%= user.username %>" required />
            <span class="helper">Usernames must be unique.</span>
          </label>
          <label>
            Bio
            <textarea name="bio" rows="4" placeholder="Tell the community about yourself."><%= user.bio || '' %></textarea>
          </label>
        </div>
      </div>
      <label>
        Avatar image
        <input class="file-input" type="file" name="avatar" accept="image/*" />
        <span class="helper">PNG, JPG, WEBP. Max 5MB.</span>
      </label>
      <div class="settings-actions">
        <button class="button primary" type="submit">Save profile</button>
      </div>
    </form>

    <form class="form-card settings-card" method="POST" action="/settings">
      <input type="hidden" name="action" value="password" />
      <h3>Change password</h3>
      <label>
        Current password
        <input type="password" name="currentPassword" required />
      </label>
      <label>
        New password
        <input type="password" name="newPassword" required />
      </label>
      <label>
        Confirm new password
        <input type="password" name="confirmPassword" required />
      </label>
      <div class="settings-actions">
        <button class="button primary" type="submit">Update password</button>
      </div>
    </form>

    <div class="form-card settings-card">
      <h3>Connected accounts</h3>
      <p class="muted">Link external accounts for faster sign-in and sharing.</p>
      <div class="linked-account">
        <div>
          <strong>Google</strong>
          <p class="muted">
            <%= user.google_email ? `Linked as ${user.google_email}` : 'Not linked yet.' %>
          </p>
        </div>
        <div class="linked-actions">
          <% if (user.google_id) { %>
            <form method="POST" action="/settings">
              <input type="hidden" name="action" value="unlink_google" />
              <button class="button ghost small" type="submit">Unlink</button>
            </form>
          <% } else { %>
            <a class="button primary small" href="/auth/google?action=link">Connect Google</a>
          <% } %>
        </div>
      </div>
      <form class="linked-account-form" method="POST" action="/settings">
        <input type="hidden" name="action" value="steam" />
        <div>
          <strong>Steam</strong>
          <p class="muted">Add a Steam profile link to show your gaming identity.</p>
        </div>
        <label>
          Steam profile URL
          <input type="url" name="steam_profile_url" placeholder="https://steamcommunity.com/id/yourname" value="<%= user.steam_profile_url || '' %>" />
        </label>
        <label>
          Steam ID (optional)
          <input type="text" name="steam_id" placeholder="7656119..." value="<%= user.steam_id || '' %>" />
        </label>
        <div class="settings-actions">
          <button class="button ghost" type="submit">
            <%= user.steam_profile_url || user.steam_id ? 'Update Steam' : 'Link Steam' %>
          </button>
        </div>
      </form>
    </div>

    <div class="form-card settings-card">
      <h3>Connected accounts</h3>
      <p class="muted">Link external accounts for faster sign-in and sharing.</p>
      <div class="linked-account">
        <div>
          <strong>Google</strong>
          <p class="muted">
            <%= user.google_email ? `Linked as ${user.google_email}` : 'Not linked yet.' %>
          </p>
        </div>
        <div class="linked-actions">
          <% if (user.google_id) { %>
            <form method="POST" action="/settings">
              <input type="hidden" name="action" value="unlink_google" />
              <button class="button ghost small" type="submit">Unlink</button>
            </form>
          <% } else { %>
            <a class="button primary small" href="/auth/google?action=link">Connect Google</a>
          <% } %>
        </div>
      </div>
      <form class="linked-account-form" method="POST" action="/settings">
        <input type="hidden" name="action" value="steam" />
        <div>
          <strong>Steam</strong>
          <p class="muted">Add a Steam profile link to show your gaming identity.</p>
        </div>
        <label>
          Steam profile URL
          <input type="url" name="steam_profile_url" placeholder="https://steamcommunity.com/id/yourname" value="<%= user.steam_profile_url || '' %>" />
        </label>
        <label>
          Steam ID (optional)
          <input type="text" name="steam_id" placeholder="7656119..." value="<%= user.steam_id || '' %>" />
        </label>
        <div class="settings-actions">
          <button class="button ghost" type="submit">
            <%= user.steam_profile_url || user.steam_id ? 'Update Steam' : 'Link Steam' %>
          </button>
        </div>
      </form>
    </div>

    <form class="form-card settings-card" method="POST" action="/settings">
      <input type="hidden" name="action" value="notifications" />
      <h3>Notifications</h3>
      <label class="checkbox">
        <input type="checkbox" name="notification_enabled" <%= user.notification_enabled ? 'checked' : '' %> />
        Notify me about order updates and messages.
      </label>
      <label class="checkbox">
        <input type="checkbox" name="marketing_enabled" <%= user.marketing_enabled ? 'checked' : '' %> />
        Send me marketplace news and promos.
      </label>
      <div class="settings-actions">
        <button class="button ghost" type="submit">Save preferences</button>
      </div>
    </form>

    <div class="form-card settings-card">
      <h3>Your listings</h3>
      <p class="muted">Edit listing details, pricing, and photos anytime.</p>
      <% if (listings.length) { %>
        <div class="settings-listings">
          <% listings.forEach(listing => { %>
            <div class="settings-listing">
              <img src="<%= listing.image_url %>" alt="<%= listing.title %>" />
              <div>
                <h4><%= listing.title %></h4>
                <p class="muted"><%= formatPrice(listing.price_cents) %></p>
              </div>
              <div class="settings-listing-actions">
                <a class="button ghost small" href="/listings/<%= listing.id %>/edit">Edit</a>
                <form method="POST" action="/listings/<%= listing.id %>/delete" onsubmit="return confirm('Delete this listing? This cannot be undone.');">
                  <button class="button danger ghost small" type="submit">Delete</button>
                </form>
              </div>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <div class="empty-state">
          <p>You do not have any listings yet.</p>
        </div>
      <% } %>
      <div class="settings-actions">
        <a class="button primary" href="/listings/new">Create new listing</a>
      </div>
    </div>

    <div class="form-card settings-card">
      <h3>Session management</h3>
      <p class="muted">Log out to end this session. More device controls coming soon.</p>
      <form method="POST" action="/auth/logout">
        <div class="settings-actions">
          <button class="button danger" type="submit">Log out</button>
        </div>
      </form>
    </div>
  </div>
</section>
<%- include('../partials/footer') %>
