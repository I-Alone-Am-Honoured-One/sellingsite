<%- include('../partials/header') %>
<section class="container section">
  <div class="detail-grid">
    <div class="detail-card">
      <img class="detail-image" src="<%= listing.image_url %>" alt="<%= listing.title %>" />
      <div class="detail-tags">
        <span class="badge accent"><%= listing.category %></span>
        <span class="badge ghost"><%= listing.condition %></span>
      </div>
    </div>
    <div>
      <h1><%= listing.title %></h1>
      <p class="price large"><%= formatPrice(listing.price_cents) %></p>
      <p class="meta">Listed by <%= listing.seller_name %></p>
      <p class="meta">Favorited by <%= favoriteCount %> shoppers</p>
      <p class="description"><%= listing.description %></p>
      <div class="info-box">
        <h4>Buyer protection</h4>
        <p>Escrow holds funds until delivery is confirmed or auto-confirmed after 24 hours.</p>
      </div>
      <div class="action-row">
        <% if (currentUser) { %>
          <% if (currentUser.id === listing.seller_id) { %>
            <div class="notice">You can’t purchase your own listing.</div>
            <a class="button ghost" href="/listings/<%= listing.id %>/edit">Edit listing</a>
          <% } else { %>
            <form method="POST" action="/listings/<%= listing.id %>/buy">
              <button class="button primary" type="submit">Buy now</button>
            </form>
            <form class="inline-message-form" method="POST" action="/messages/new">
              <input type="hidden" name="listing_id" value="<%= listing.id %>" />
              <input type="text" name="body" placeholder="Ask the seller a question..." required />
              <button class="button ghost" type="submit">Message seller</button>
            </form>
            <form method="POST" action="/listings/<%= listing.id %>/favorite">
              <button class="button <%= isFavorited ? 'primary' : 'ghost' %> favorite-toggle" type="submit">
                <%= isFavorited ? '★ Favorited' : '☆ Add to favorites' %>
              </button>
            </form>
          <% } %>
        <% } else { %>
          <a class="button primary" href="/auth/sign-in">Sign in to buy</a>
          <a class="button ghost" href="/auth/sign-in">Sign in to message</a>
        <% } %>
      </div>
    </div>
  </div>
</section>
<%- include('../partials/footer') %>
